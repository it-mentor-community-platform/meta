# Системная аналитика - импорт данных

## Необходимый контекст

- [Бизнес аналитика - импорт данных](https://github.com/it-mentor-community-platform/meta/blob/main/business-analytics/functionality/data-import.md)
- Работа с Google Spreadsheet таблицами из Java

## Импорт пользователей

### Шаги

- Запрос к `POST /api/data-importer/start-users-import` с ролью `ADMIN`
- Data Importer валидирует роль пользователя в заголовке `X-User-Roles`
- В случае наличия нужной роли и доступа к Google Spreadsheet таблице Data Importer отвечает 200 на исходный запрос и запускает асинхронный процесс импорта данных
  - Открываем Google Spreadsheet таблицу, лист "Telegram аккаунты студентов"
  - Для каждого ряда, кроме заголовка, извлекаем Telegram User Id, определяем роль (об этом ниже)
  - Вызываем `POST /api/auth/internal/user`
- Обработчик `POST /api/auth/internal/user` в Auth Service:
  - Обрабатываем переданный объект, делаем UPSERT пользователю в таблице `Users`, обновляем роли

### Требования

- Конкретная Google Spreadsheet таблица устанавливается через конфиг. Для удобства локальной разработки полезно создать свою копию таблицы и управлять её содержимым (прав на редактирование в основной таблицы у разработчиков нет). Ссылка на основную таблицу есть в [бизнес аналитике](https://github.com/it-mentor-community-platform/meta/blob/main/business-analytics/functionality/data-import.md)
- Роли пользователя могут меняться (как добавляться, так и удаляться)
- Роль каждого импортируемого пользователя, по-умолчанию, `STUDENT`. Исключение - пользователи, айди которых перечислены как админские в конфигурации приложения

### Допущения

- Студенты не могут быть удалены из таблицы, поэтому при синхронизации данных допускаем, что нам не нужно проверять существование в таблице каждого ранее добавленного пользователя
- Метод доступен только для админов, поэтому не усложняем реализацию Shedlock'ом, ручной синхронизацией или любым другим способом запретить множественный запуск одновременных процессов импорта в распределённом окружении (допустим, если Data Importer запущен в двух репликах). Для простоты запускаем импорт асинхронно в пуле потоков, состоящем из одного потока

## Импорт гарантированных ревью

[Продовая таблица](https://docs.google.com/spreadsheets/d/1DkIIcE6oUtcK9jjfrOyUgatb6DIxL5GXEn3kvUp4Lms/edit?gid=0#gid=0) гарантированных ревью.

### Шаги

- Запрос к `POST /api/data-importer/start-guaranteed-reviews-import` с ролью `ADMIN`
- Data Importer валидирует роль пользователя в заголовке `X-User-Roles`
- В случае наличия нужной роли и доступа к Google Spreadsheet таблице Data Importer отвечает 200 на исходный запрос и запускает асинхронный процесс импорта данных
  - Открываем таблицу
  - Для каждого ряда, начиная с 7, читаем Telegram url ментора, языки, цену
    - Для каждого языка делаем запрос `POST /api/mentor/internal/guaranteed-review`
- Обработчик `POST /api/mentor/internal/guaranteed-review` в Mentor Service:
  - Запрашиваем `GET /api/profile/internal/profile/by-telegram-url`, чтобы получить telegram user id ментора, зная его Telegram url
  - Обрабатываем переданный объект, делаем UPSERT ментора в таблице `Mentors`, UPSERT цены на ревью в таблице `Guaranteed_Reviews_Prices` 

### Требования

- Конкретная Google Spreadsheet таблица устанавливается через конфиг. Для удобства локальной разработки полезно создать свою копию таблицы и управлять её содержимым (прав на редактирование в основной таблицы у разработчиков нет). Ссылка на основную таблицу - [продовая таблица](https://docs.google.com/spreadsheets/d/1DkIIcE6oUtcK9jjfrOyUgatb6DIxL5GXEn3kvUp4Lms/edit?gid=0#gid=0)

### Допущения

- Цены на данный момент только в долларах, другие валюты не подразумеваются
